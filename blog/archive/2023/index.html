
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../">
      
      
      
      <link rel="icon" href="../../../static/favicon-32x32.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.0-b3">
    
    
      
        <title>2023 - Homepage of Patrik Hlobil</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.83068744.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../static/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Homepage of Patrik Hlobil" class="md-header__button md-logo" aria-label="Homepage of Patrik Hlobil" data-md-component="logo">
      
  <img src="../../../static/portrait.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Homepage of Patrik Hlobil
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PatrikHlobil/Blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Blog
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Homepage of Patrik Hlobil" class="md-nav__button md-logo" aria-label="Homepage of Patrik Hlobil" data-md-component="logo">
      
  <img src="../../../static/portrait.jpg" alt="logo">

    </a>
    Homepage of Patrik Hlobil
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PatrikHlobil/Blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../links.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Links
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2023">2023<a class="headerlink" href="#2023" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-08-01 00:00:00">August 1, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="5-reasons-why-code-comments-are-a-code-smell"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/">5 Reasons why Code Comments are a Code Smell</a></h2>
<p><img align="right" alt="Async Python" src="../../assets/images/stop_comments.svg" /></p>
<h3 id="1-comments-that-just-describe-what-is-happening"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#1-comments-that-just-describe-what-is-happening">1. Comments that just describe what is happening</a></h3>
<p>Let's have a look at the following code example:
<div class="highlight"><pre><span></span><code><span class="c1">##################</span>
<span class="c1">##### Imports ####</span>
<span class="c1">##################</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="c1">## Define path to executable:</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/executable&quot;</span>

<span class="c1">## Extract directory: </span>
<span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> 

<span class="c1">## Print Directory of executable:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></p>
<p>These comments just obvioulsy just describe what happens in the code below them. This is however not necessary, because the code is easy to read if we just <strong>name the variables better</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os.path</span>

<span class="n">path_to_executable</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/executable&quot;</span>
<span class="n">directory_of_executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_executable</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">directory_of_executable</span><span class="p">)</span>
</code></pre></div>
<h3 id="2-comments-are-a-sign-of-too-complex-logic"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#2-comments-are-a-sign-of-too-complex-logic">2. Comments are a sign of too complex logic</a></h3>
<p>Often, we see code comments when the code deals with complex or nested logic:</p>
<div class="highlight"><pre><span></span><code><span class="c1">## We do have to check, that the credit card of the user is not expired and that the user is solvent.</span>
<span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;solvent&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="o">.</span><span class="n">get_expiration_dt</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
    <span class="c1"># If we process Visa cards, online payment service has to be enabled:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Visa&quot;</span> <span class="ow">and</span> <span class="s2">&quot;online_payment&quot;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="o">.</span><span class="n">payment_services</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">OnlinePaymentServiceNotEnabledException</span><span class="p">(</span><span class="s2">&quot;Visa Payment not possible.&quot;</span><span class="p">)</span> 
    <span class="n">process_payment</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="p">,</span> <span class="n">payment_details</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PaymentException</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This is not optimal to read and also there is the danger, that the comments will be outdated (see below) after some time. It is in this case better to define small functions with a proper name that describe what happens within the code:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">is_solvent</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="ow">and</span> <span class="n">credit_card_is_active</span><span class="p">(</span><span class="n">credit_card</span><span class="o">:=</span><span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">credit_card</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Visa&quot;</span> <span class="ow">and</span> <span class="n">online_payment_service_enabled</span><span class="p">(</span><span class="n">credit_card</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">OnlinePaymentServiceNotEnabledException</span><span class="p">(</span><span class="s2">&quot;Visa Payment not possible.&quot;</span><span class="p">)</span>
    <span class="n">process_payment</span><span class="p">(</span><span class="n">credit_card</span><span class="p">,</span> <span class="n">payment_details</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PaymentException</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_solvent</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;solvent&quot;</span>

<span class="k">def</span> <span class="nf">credit_card_is_active</span><span class="p">(</span><span class="n">credit_card</span><span class="p">:</span> <span class="n">CreditCard</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">credit_card</span><span class="o">.</span><span class="n">get_expiration_dt</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span>

<span class="k">def</span> <span class="nf">online_payment_service_enabled</span><span class="p">(</span><span class="n">credit_card</span><span class="p">:</span> <span class="n">CreditCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;online_payment&quot;</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">credit_card</span><span class="o">.</span><span class="n">payment_services</span>
</code></pre></div>
<h3 id="3-comments-that-describe-the-implementation"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#3-comments-that-describe-the-implementation">3. Comments that describe the implementation</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The distance is calculated by:</span>
<span class="sd">            1. Calculate the difference between each components of the 2 vectors</span>
<span class="sd">            2. Square the differences</span>
<span class="sd">            3. Sum up </span>
<span class="sd">            4. Take the squareroot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">square_sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">square</span> <span class="o">=</span> <span class="n">difference</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">square_sum</span> <span class="o">+=</span> <span class="n">square</span>

    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">square_sum</span><span class="p">)</span>
</code></pre></div>
<p>Why do we need this? The code described perfectly what is happening and there is not need to describe the implementation, also because the implementation can be changed in different ways (e.g. using a high-level libary like <code>numpy</code>).</p>
<h3 id="4-comments-can-be-outdated"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#4-comments-can-be-outdated">4. Comments can be outdated</a></h3>
<p>When code is changed or refactored, the <strong>test suite</strong> should ensure that the business logic and functionality of the program is still valid. However, <strong>comments</strong> are like dead code and are likely to be untouched by the programmer at hand. Thus, if the implementation changes, the comments are more likely to not describe the logic anymore. Even worse, these outdated ...</p>
<h3 id="5-comments-can-be-missleading"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#5-comments-can-be-missleading">5. ... Comments can be missleading</a></h3>
<p>Comments can be missleading, because they are not well written (<em>"hey, this is just a comment. No need to really be carefull writing these ..."</em>) or are outdated (like stated above). </p>
<p>Consider the following example:
<div class="highlight"><pre><span></span><code><span class="c1">## User is an adult:</span>
<span class="k">if</span> <span class="n">user_age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">:</span>
    <span class="c1"># User is active</span>
    <span class="k">if</span> <span class="n">user_is_active</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotActiveException</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">UserNotOldEnoughtException</span><span class="p">()</span>
</code></pre></div></p>
<p>This is a pretty nested logic for such an easy business logic. Thus, we should invert the conditions to simplify the processing logic. So let us refactor this a bit
<div class="highlight"><pre><span></span><code><span class="c1">## User is an adult:</span>
<span class="k">if</span> <span class="n">user_age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">UserNotOldEnoughtException</span><span class="p">()</span>
<span class="c1">## User is active</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">user_is_active</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">UserNotActiveException</span><span class="p">()</span>
<span class="n">process_payment</span><span class="p">()</span>
</code></pre></div></p>
<p>This code is obviously better, so the refactoring was a good idea. However, if you look closely, we forgot to adjust the code comments and now they are missleading.</p>
<h3 id="6-outcommmented-code"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#6-outcommmented-code">6. Outcommmented code</a></h3>
<p>Since we all have a good version control system at hand today (<strong>#git</strong>), there is really no way of storing old or unfinished code in the production branch. Keep these <code>dead code</code> parts away from production, <strong>PERIOD</strong>.</p>
<p><img align="right" alt="" src="../../assets/images/searching_meaningful_variable_name.png" width="300" /></p>
<h3 id="7-comments-hide-bad-naming"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#7-comments-hide-bad-naming">7. Comments hide bad naming</a></h3>
<p>Often, comments are used to describe a variable, because there was no effort to try to name the variable <strong>properly</strong>. Look at the following example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">def</span> <span class="nf">check_token_validity</span><span class="p">(</span><span class="n">token_dt</span><span class="p">):</span>
    <span class="c1"># We check that the token timestamp is only 1 hour old</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">token_dt</span> <span class="o">&lt;</span> <span class="mi">3600</span>
</code></pre></div>
<p>There are several things that we can improve on this code snippet:</p>
<ol>
<li>The name <code>token_dt</code> implies that we have a <code>datetime</code> object at hand. However, if we look closely, we see that it is a <strong>UTC Timestamp</strong>!</li>
<li>Doing calculation in comparisons is generally a bad idea, because it makes the expression to complex to directly understand it</li>
<li>What is the 3600 doing there? What is the unit and why was it chosen? We should make it clearer what this number means.</li>
</ol>
<p>Now, let us look at the refactored code:
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">MAXIMUM_TOKEN_LIFETIME_IN_SECONDS</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>

<span class="k">def</span> <span class="nf">check_token_validity</span><span class="p">(</span><span class="n">token_timestamp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="n">token_lifetime</span> <span class="o">=</span> <span class="n">current_timestamp</span> <span class="o">-</span> <span class="n">token_timestamp</span>
    <span class="k">return</span> <span class="n">token_lifetime</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_TOKEN_LIFETIME_IN_SECONDS</span>
</code></pre></div></p>
<p>We have:
1. </p>
<h3 id="good-code-comments"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#good-code-comments">Good Code Comments</a></h3>
<p>After we have seen, that most common patterns of code comments are actually not a great idea, let us look at the exceptions:</p>
<h5 id="1-code-documentation"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#1-code-documentation">1. Code documentation</a></h5>
<p>Code documentation for public APIs like docstrings can be a great idea, especially for libraries that are consumed by 3rd parties. These docstrings can then be picked up by documentation tools like <strong>Sphinx</strong> or <strong>MKDocs</strong> for an automated generation of nice API documentation.</p>
<p>Note, that is in general not necessary to put a code comment on private functions that are not part of the public API, because they should in general not be used by external user and typically have a higher rate of change than the public APIs. Therefore, they are prone to outdated and missleading docstrings/comments as described above. Typically, for these functions you should invest in a good function name that describes properly what it does without the need of additional commentary. If this is not possible, this is often a sign of a function that does 2 or more things and should therefore be split up and refactored to reduce its complexity. </p>
<h5 id="2-links-and-additional-information-about-business-logic"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#2-links-and-additional-information-about-business-logic">2. Links and additional information about business logic</a></h5>
<p>If a programm is written as a feature of a e.g. story, it may be a good idea to reference the story at the high-level code interface. Thus, when another programmer wants to know, why a functionality has been developed in the first place, he can go back to the story or additional user documentation.</p>
<h5 id="3-additional-details-that-explain-the-reasoning-for-the-implementation-if-the-latter-is-not-obvious"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#3-additional-details-that-explain-the-reasoning-for-the-implementation-if-the-latter-is-not-obvious">3. Additional details that explain the reasoning for the implementation if the latter is not obvious</a></h5>
<p>There are code implementations or bugfixes that may not be obvious for a reader without the corresponding context. For these, there should be a reference to the corresponding issue or a comment describing the background information necessary to understand the maybe complex implementation. Think about something like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="n">run_id</span> <span class="o">=</span> <span class="n">start_run</span><span class="p">()</span>

<span class="c1">## We have to wait a few seconds for the server to respond after the submission of a run. If we query for the run status</span>
<span class="c1">## too early, we will get an error, because the internal database of the service has to catch up:</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">WAIT_TIME_IN_SECONDS</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">run_finished</span> <span class="o">=</span> <span class="n">poke_for_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">run_finished</span><span class="p">:</span>
        <span class="k">break</span>
</code></pre></div>
<p>A programmer without detailed knowledge of the external system will need additional information about the intend of a chosen solution to understand the reasoning.</p>
<h5 id="4-todo-comments"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#4-todo-comments">4. TODO Comments</a></h5>
<p>Sometimes, when working on code we find a part of the code that is not well written or might have a bad side effect in the future, but we do not have the time to directly work on the problem. Or we see that we can improve an implementation and make it way more efficient. Leaving a <code># TODO</code> comment can be a great way of finding those pieces in your code to later work on them.</p>
<h5 id="5-warnings"><a class="toclink" href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/#5-warnings">5. Warnings</a></h5>
<p>Sometimes, there is a strange side effect or just something that a user has to know before he is calling the function at hand. Here, a warning comment may be appropriate.</p>

    <nav class="md-post__action">
      <a href="../../2023/08/01/5-reasons-why-code-comments-are-a-code-smell/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-12 00:00:00">June 12, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="marp-markdown-presentation-ecosystem"><a class="toclink" href="../../2023/06/12/marp-markdown-presentation-ecosystem/">Marp: Markdown Presentation Ecosystem</a></h2>
<h3 id="what-is-marp"><a class="toclink" href="../../2023/06/12/marp-markdown-presentation-ecosystem/#what-is-marp">What is Marp?</a></h3>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><a href="https://marp.app/">Marp</a> (also known as the Markdown Presentation Ecosystem) provides an intuitive experience for creating beautiful slide decks. You only have to focus on writing your story in a Markdown document.</p>
</div>
<p>Here you find a few good references if you wish to get started using <strong>Marp</strong>:</p>
<ul>
<li><a href="https://marp.app/">https://marp.app/</a></li>
<li><a href="https://marpit.marp.app/">https://marpit.marp.app/</a></li>
<li><a href="https://chris-ayers.com/2023/03/31/customizing-marp">https://chris-ayers.com/2023/03/31/customizing-marp</a></li>
<li><a href="https://www.youtube.com/watch?v=EzQ-p41wNEE">https://www.youtube.com/watch?v=EzQ-p41wNEE</a></li>
</ul>
<h3 id="how-to-build-a-cool-presentation"><a class="toclink" href="../../2023/06/12/marp-markdown-presentation-ecosystem/#how-to-build-a-cool-presentation">How to build a cool presentation</a></h3>
<p><strong>Marp</strong> is a really powerful tool to build an HTML presentation using Markdown. It can be developed inside VS Code (see e.g. https://www.youtube.com/watch?v=EzQ-p41wNEE) and the HTML can be directly exported there.</p>
<p>Let me give you an example presentation that shows how easy it is: </p>
<iframe src="../images/marp-presentation.html" title="Marp Presentation" width=800 height=600></iframe>

<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 3h8a2 2 0 0 1 2-2 2 2 0 0 1 2 2h8v2h-1v11h-5.75L17 22h-2l-1.75-6h-2.5L9 22H7l1.75-6H3V5H2V3m3 2v9h14V5H5m6.85 6.85a.49.49 0 0 1-.35.15.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 .5-.5c.14 0 .26.06.35.15l1.4 1.39c.32.32.64.64.64.96 0 .32-.32.64-.64.96l-1.4 1.39Z"/></svg></span> <a href="../../posts/images/marp-presentation.html">Marp Example Presenation</a></p>
<h4 id="example"><a class="toclink" href="../../2023/06/12/marp-markdown-presentation-ecosystem/#example">Example:</a></h4>
<div class="highlight"><pre><span></span><code>---
paginate: true
marp: true
theme: uncover
class: invert
style: |
  .small-red-text {
    font-size: 0.75rem;
    color: red;
  }

  h1 {
    font-size: 60px;
  }

  h2 {
    font-size: 50px;
  } 

  h3 {
    font-size: 40px;
  }

  h4 {
    font-size: 30px;
  }

  h5,h6,p,li,code,table {
    font-size: 25px;
  }
headingDivider: 1
<span class="gu">math: mathjax</span>
<span class="gu">---</span>


<span class="gu">## **Marp**</span>


![<span class="nt">bg left:40% 80%</span>](<span class="na">https://marp.app/assets/marp.svg</span>)

Markdown Presentation Ecosystem

https://marp.app/


<span class="gu">## How to write slides</span>

Split pages by horizontal ruler (<span class="sb">`---`</span>). It&#39;s very simple! :satisfied:

<span class="sb">```markdown</span>
<span class="gu">## Slide 1</span>

foobar


<span class="gu">## Slide 2</span>

foobar
<span class="sb">```</span>

Alternatively, set the <span class="gs">**directive**</span> [<span class="nt">headingDivider</span>](<span class="na">https://marpit.marp.app/directives?id=heading-divider</span>). To automatically split at <span class="sb">`h1`</span> headers add to the document metadata:
<span class="sb">```md</span>
headingDivider: 1
<span class="sb">```</span>


<span class="gu">## Markdown !!!</span>

<span class="ge">*Just*</span> <span class="gs">**write**</span> <span class="sb">`Markdown`</span> ==here==!!!

<span class="k">-</span><span class="w"> </span>Bullet 1
<span class="k">-</span><span class="w"> </span>Bullet 2

<span class="gu">#### Subtitle</span>

[<span class="nt">Marp Link</span>](<span class="na">https://marpit.marp.app/</span>)

<span class="gs">**Emojies**</span>: :joy: :wink: :smile: :rocket:


<span class="gu">## Markdown !!!</span>
<span class="gu">##### Use automatic syntax highlighting</span>
<span class="sb">```python</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="sb">```</span>


<span class="gu">## Markdown !!!</span>

<span class="gu">#### Tables</span>

| Syntax      | Description | Test Text     |
| :---        |    :----:   |          ---: |
| Header      | Title       | Here&#39;s this   |
| Paragraph   | Text        | And more      |


<span class="gu">## Markdown !!!</span>

<span class="gu">### Crazy Math</span>
&lt;!-- _footer: You have to add <span class="gs">**math: mathjax**</span> to the document metadata --&gt;
$$ 
f(a) = \frac{1}{2 \pi i} \oint_\gamma \frac{f(z)}{z-a} dz
$$


<span class="gu">## Custom Backgrounds</span>

![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/background.png</span>)

Use <span class="gs">**Image Directives**</span> (local or web-resource):

<span class="sb">```md</span>
![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/background.png</span>)
<span class="sb">```</span>


<span class="gu">## Custom Backgrounds</span>

![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)

![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
<span class="gs">**Multiple Backgrounds!!!**</span>

<span class="sb">```md</span>
![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)

![<span class="nt">bg</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
<span class="sb">```</span>


<span class="gu">## Images</span>

Put Images to the left

![<span class="nt">bg left</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```md</span>
![<span class="nt">bg left</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```</span>

<span class="gu">## Images</span>

... or to the right

![<span class="nt">bg right</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```md</span>
![<span class="nt">bg right</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```</span>

<span class="gu">## Images</span>

... or adjust the width ...

![<span class="nt">bg left:25%</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```md</span>
![<span class="nt">bg left:25%</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/cats.jpg</span>)
<span class="sb">```</span>


<span class="gu">## Images</span>

... or apply filters:

![<span class="nt">bg left sepia</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
![<span class="nt">bg right blur</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
<span class="sb">```md</span>
![<span class="nt">bg left sepia</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
![<span class="nt">bg right blur</span>](<span class="na">https://patrikhlobil.github.io/Blog/blogs/images/sea.jpg</span>)
<span class="sb">```</span>


<span class="gu">## GIFS !!!</span>
<span class="sb">```</span>
<span class="sb">![bg right](https://media0.giphy.com/media/SbtWGvMSmJIaV8faS8/200w.webp?</span>
<span class="sb">cid=ecf05e47i5eyozrdt5aytc41m0o7ea6uxu6ck2088uxo4ojz&amp;ep=v1_gifs_search&amp;rid=200w.webp&amp;ct=g)</span>
<span class="sb">```</span>
![<span class="nt">bg</span>](<span class="na">https://media0.giphy.com/media/SbtWGvMSmJIaV8faS8/200w.webp?cid=ecf05e47i5eyozrdt5aytc41m0o7ea6uxu6ck2088uxo4ojz&amp;ep=v1_gifs_search&amp;rid=200w.webp&amp;ct=g</span>)


<span class="gu">## Mermaid Support</span>

&lt;!-- Add this anywhere in your Markdown file --&gt;
&lt;script type=&quot;module&quot;&gt;
  import mermaid from &#39;https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs&#39;;
  mermaid.initialize({ startOnLoad: true });
&lt;/script&gt;

&lt;div class=&quot;mermaid&quot;&gt;
journey
    title My working day
    section Go to work
      Make tea: 5: Me
      Go upstairs: 3: Me
      Do work: 1: Me, Cat
    section Go home
      Go downstairs: 5: Me
      Sit down: 3: Me
&lt;/div&gt;

<span class="gu">## HTML Support</span>

Add custom CSS to document metadata
<span class="gu">```</span>
<span class="gu">---</span>
marp: true
style: |
  .small-red-text {
    font-size: 0.75rem;
    color: red;
<span class="gu">  }</span>
<span class="gu">---</span>
<span class="gu">## Title</span>
&lt;div class=&quot;small-red-text&quot;&gt; Small Red Text&lt;/div&gt;
<span class="sb">```</span>


<span class="sb">&lt;div class=&quot;small-red-text&quot;&gt; Small Red Text&lt;/div&gt;</span>

<span class="sb">## HTML Support</span>

<span class="sb">&lt;div id=&quot;myDiv&quot;&gt; &lt;/div&gt;</span>
<span class="sb">&lt;script src=&#39;https://cdn.plot.ly/plotly-2.24.1.min.js&#39;&gt;&lt;/script&gt;</span>
<span class="sb">&lt;script src=&#39;https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js&#39;&gt;&lt;/script&gt;</span>

<span class="sb">&lt;script&gt;</span>
<span class="sb">d3.json(&#39;https://raw.githubusercontent.com/plotly/plotly.js/master/test/image/mocks/sankey_energy.json&#39;, function(fig){</span>

<span class="sb">var data = {</span>
<span class="sb">  type: &quot;sankey&quot;,</span>
<span class="sb">  domain: {</span>
<span class="sb">    x: [0,1],</span>
<span class="sb">    y: [0,1]</span>
<span class="sb">  },</span>
<span class="sb">  orientation: &quot;h&quot;,</span>
<span class="sb">  valueformat: &quot;.0f&quot;,</span>
<span class="sb">  valuesuffix: &quot;TWh&quot;,</span>
<span class="sb">  node: {</span>
<span class="sb">    pad: 15,</span>
<span class="sb">    thickness: 15,</span>
<span class="sb">    line: {</span>
<span class="sb">      color: &quot;black&quot;,</span>
<span class="sb">      width: 0.5</span>
<span class="sb">    },</span>
<span class="sb">   label: fig.data[0].node.label,</span>
<span class="sb">   color: fig.data[0].node.color</span>
<span class="sb">      },</span>

<span class="sb">  link: {</span>
<span class="sb">    source: fig.data[0].link.source,</span>
<span class="sb">    target: fig.data[0].link.target,</span>
<span class="sb">    value: fig.data[0].link.value,</span>
<span class="sb">    label: fig.data[0].link.label</span>
<span class="sb">  }</span>
<span class="sb">}</span>

<span class="sb">var data = [data]</span>

<span class="sb">var layout = {</span>
<span class="sb">  title: &quot;Energy forecast for 2050&lt;br&gt;Source: Department of Energy &amp; Climate Change, Tom Counsell via &lt;a href=&#39;https://bost.ocks.org/mike/sankey/&#39;&gt;Mike Bostock&lt;/a&gt;&quot;,</span>
<span class="sb">  width: 1000,</span>
<span class="sb">  height: 500,</span>
<span class="sb">  font: {</span>
<span class="sb">    size: 10</span>
<span class="sb">  }</span>
<span class="sb">}</span>

<span class="sb">Plotly.newPlot(&#39;myDiv&#39;, data, layout)</span>
<span class="sb">});</span>

<span class="sb">&lt;/script&gt;</span>


<span class="sb">## Fragmented lists</span>

<span class="sb">Use `*` to get a fragmented list, where each item appears one after each other and `-` to directly display all items.</span>

<span class="sb">#### Non-Fragmented</span>

<span class="sb">- non-frag 1</span>
<span class="sb">- non-frag 2</span>

<span class="sb">#### Fragmented</span>

<span class="sb">* frag 1</span>
<span class="sb">* frag 2</span>


<span class="sb">## Speaker Notes</span>

<span class="sb">Just add **Speaker Notes** via:</span>
<span class="sb">```html</span>
<span class="sb">&lt;!-- </span>
<span class="sb">Some notes here that might be useful.</span>
<span class="sb">--&gt;</span>
<span class="sb">```</span>


&lt;!-- 
Some notes here that might be useful.
--&gt;

<span class="gu">## Directives</span>

&lt;!-- _backgroundColor: <span class="ni">#180f61</span> --&gt;

With <span class="sb">`Directives`</span>, it is easy to modify the behaviour of <span class="gs">**Marp**</span> for a single slide or the whole presentation.

<span class="gu">##### Local Directives</span>

Using local directives (prepend with <span class="sb">`_`</span>), one can modify a single page, e.g.
<span class="sb">```html</span>
<span class="cm">&lt;!-- _backgroundColor: #180f61 --&gt;</span>
<span class="sb">```</span>

<span class="gu">##### Global Directives</span>

Using global directives, one can modify the bejaviour of the slides from the current slide on
<span class="sb">```html</span>
<span class="cm">&lt;!-- backgroundColor: aqua --&gt;</span>
<span class="sb">```</span>
</code></pre></div>

    <nav class="md-post__action">
      <a href="../../2023/06/12/marp-markdown-presentation-ecosystem/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-23 00:00:00">April 23, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              18 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="async-python"><a class="toclink" href="../../2023/04/23/async-python/">Async Python</a></h2>
<p><img align="right" alt="Async Python" src="../../assets/images/async_python.png" /></p>
<h3 id="parallelism-in-python"><a class="toclink" href="../../2023/04/23/async-python/#parallelism-in-python">Parallelism in Python</a></h3>
<p>There exists 3 distinct ways to parallelize code in Python, namely <strong>threading, multiprocessing, and async</strong>. All 3 methods are based upon a different idea. However, the first 2 are a more indirect way to get parallelism, where the operating system's scheduler is involved, whereas the later introduces a completely new paradigm for programming in python (<code>async/await)</code>. </p>
<p>In this article, we will quickly introduce each of the concepts, apply them for 2 code examples and performing benchmarks to compare them. Let us first introduce the 2 scripts that we are going to parallelize. </p>
<p>The first example <code>sleep.py</code> introduces a simple script, that executed a function <strong>do_work</strong> 5 times. The function itself just sleeps for 2 seconds, mocking the waiting to an external resource like a database of an HTTPS response:</p>
<div class="highlight"><span class="filename">sleep.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">do_work</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>The second example <code>hard_work.py</code> has the same structure, however the Python function <strong>do_real_work</strong> performs actual work on the CPU and calculates a sum using a for loop.</p>
<div class="highlight"><span class="filename">hard_work.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">def</span> <span class="nf">do_real_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">do_real_work</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="synchronous-execution"><a class="toclink" href="../../2023/04/23/async-python/#synchronous-execution">Synchronous execution</a></h4>
<p>When we execute the 2 scripts above, we get the following output
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 sleep.py

0:00:00.000010: Start work for number=0
0:00:02.005169: Finished work for number=0
0:00:02.005421: Start work for number=1
0:00:04.008039: Finished work for number=1
0:00:04.008167: Start work for number=2
0:00:06.010063: Finished work for number=2
0:00:06.010195: Start work for number=3
0:00:08.011329: Finished work for number=3
0:00:08.011481: Start work for number=4
0:00:10.016531: Finished work for number=4
Finished program after 0:00:10.016634
</code></pre></div></p>
<p>and:
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 hard_work.py

0:00:00.000005: Start work for number=0
0:00:02.352451: Finished work for number=0
0:00:02.352548: Start work for number=1
0:00:04.687044: Finished work for number=1
0:00:04.687078: Start work for number=2
0:00:07.084300: Finished work for number=2
0:00:07.084339: Start work for number=3
0:00:09.425129: Finished work for number=3
0:00:09.425161: Start work for number=4
0:00:11.770652: Finished work for number=4
Finished program after 0:00:11.770680
</code></pre></div></p>
<p>Thus we can see the following execution times<sup id="fnref:1"><a class="footnote-ref" href="../../2023/04/23/async-python/#fn:1">1</a></sup>:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>Synchronous Execution</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>sleep.py</strong></td>
<td style="text-align: center;">10</td>
</tr>
<tr>
<td style="text-align: center;"><strong>do_work.py</strong></td>
<td style="text-align: center;">11.8</td>
</tr>
</tbody>
</table>
<h4 id="threading"><a class="toclink" href="../../2023/04/23/async-python/#threading">Threading</a></h4>
<p>Using the <code>threading</code> module in Python, one cas easily execute parallel tasks. We then get for the first example:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Code</label><label for="__tabbed_1_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">sleep.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>


<span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">do_work</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 sleep.py

0:00:00.000071: Start work for number=0
0:00:00.000126: Start work for number=1
0:00:00.000168: Start work for number=2
0:00:00.000205: Start work for number=3
0:00:00.000246: Start work for number=4
0:00:02.005241: Finished work for number=0
0:00:02.005388: Finished work for number=4
0:00:02.005453: Finished work for number=1
0:00:02.005475: Finished work for number=2
0:00:02.005430: Finished work for number=3
Finished program after 0:00:02.006002
</code></pre></div>
</div>
</div>
</div>
<p>As can be seen, the program has finished in only 2 seconds instead of 10 seconds, because alls tasks have been processed in parallel and have a runtime of 2 seconds.</p>
<p>However, when we do the same for the other example:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Code</label><label for="__tabbed_2_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">hard_work.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">def</span> <span class="nf">do_real_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">do_real_work</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 hard_work.py

0:00:00.000125: Start work for number=0
0:00:00.000200: Start work for number=1
0:00:00.019017: Start work for number=2
0:00:00.049231: Start work for number=3
0:00:00.080564: Start work for number=4
0:00:10.813826: Finished work for number=2
0:00:10.885100: Finished work for number=3
0:00:10.988489: Finished work for number=0
0:00:11.014248: Finished work for number=1
0:00:11.020219: Finished work for number=4
Finished program after 0:00:11.020369
</code></pre></div>
</div>
</div>
</div>
<p>we still need 11 seconds like in the synchronous execution. The reason for this lies in the way <strong>threading</strong> is handled by the CPython interpreter. Due to the <strong>Global Interpreter Lock</strong> (GIL), Python ensures that at each moment only one thread can be actively executing the code. Therefore, we are executing multiple functions in parallel, but we are effectively still using only 1 core at a time. This can be seen in the image below.</p>
<figure>
<p><img alt="Threading and the GIL" src="../../assets/images/threading.svg" width="1000" />
  </p>
<figcaption>Work of a Python code with threads (GIL blocking of true parallelism)</figcaption>
</figure>
<p>In the sleep example above, the function was basically doing nothing except waiting (mimicking for example a wait time due to a database or HTTP request). Therefore, the parallel execution works fine, because there is no <strong>real work</strong> to be done.</p>
<p>For the <code>hard_work.py</code> code snippet, the execution time is really spent doing actual Python code execution. As can be seen in the output, all 5 tasks will start nearly the same time, but since it will only get 1/5 of the CPU, each task will need about 5 times as much time. As a result, there is no speed improvement when using <code>threading in Python</code> for computiationally expensive applications.</p>
<p>The observed execution times so far:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>Synchronous Execution</strong></th>
<th><strong>Threading</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>sleep.py</strong></td>
<td style="text-align: center;">10</td>
<td>2</td>
</tr>
<tr>
<td style="text-align: center;"><strong>do_work.py</strong></td>
<td style="text-align: center;">11.8</td>
<td>11</td>
</tr>
</tbody>
</table>
<h4 id="multiprocessing"><a class="toclink" href="../../2023/04/23/async-python/#multiprocessing">Multiprocessing</a></h4>
<p>Real <code>multiprocessing</code> can be used in Python very similar to Threads. Note that in this case, the processed are encapulated in seperate child processed and cannot (easily) access the data from other processes. Let us again modify our two code examples:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Code</label><label for="__tabbed_3_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">sleep.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>


<span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">do_work</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 sleep.py

0:00:00.006796: Start work for number=0
0:00:00.007449: Start work for number=1
0:00:00.008078: Start work for number=2
0:00:00.008823: Start work for number=3
0:00:00.009255: Start work for number=4
0:00:02.008293: Finished work for number=0
0:00:02.008291: Finished work for number=1
0:00:02.009784: Finished work for number=3
0:00:02.009597: Finished work for number=2
0:00:02.010936: Finished work for number=4
Finished program after 0:00:02.013174
</code></pre></div>
</div>
</div>
</div>
<hr />
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Code</label><label for="__tabbed_4_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">hard_work.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">do_real_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">do_real_work</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
    <span class="n">task</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 hard_work.py

0:00:00.007729: Start work for number=0
0:00:00.008396: Start work for number=1
0:00:00.008928: Start work for number=2
0:00:00.011777: Start work for number=3
0:00:00.012632: Start work for number=4
0:00:02.649805: Finished work for number=2
0:00:02.655102: Finished work for number=1
0:00:02.688040: Finished work for number=3
0:00:02.738391: Finished work for number=4
0:00:02.888424: Finished work for number=0
Finished program after 0:00:02.889433
</code></pre></div>
</div>
</div>
</div>
<p>Now, we finally see real Python use several cores of our CPU to execute the tasks in parallel. This leads us to the following execution times:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>Synchronous Execution</strong></th>
<th><strong>Threading</strong></th>
<th><strong>Multiprocessing</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>sleep.py</strong></td>
<td style="text-align: center;">10</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td style="text-align: center;"><strong>do_work.py</strong></td>
<td style="text-align: center;">11.8</td>
<td>11</td>
<td>2.8</td>
</tr>
</tbody>
</table>
<h4 id="asynchronous-python"><a class="toclink" href="../../2023/04/23/async-python/#asynchronous-python">Asynchronous Python</a></h4>
<p>The last paradigm to execute Python code in parallel is the use of <code>async/await</code>. This method kind of resembles the <code>threading</code> idea. However, in this case it is not the OS Scheduler that is assigning resources to the tasks/threads, but the async event loop scheduler of Python<sup id="fnref:2"><a class="footnote-ref" href="../../2023/04/23/async-python/#fn:2">2</a></sup>. There are several key advantages in comparison to regular threading:</p>
<ol>
<li>Reduces overhead since no additional threads have to be scheduled by the OS</li>
<li>More parallel tasks can be scheduled in parallel</li>
<li><code>async/await</code> allows for control, where tasks can be paused and resumed</li>
</ol>
<hr />
<p>Let us now have a look at the <code>sleep</code> example:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Code</label><label for="__tabbed_5_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">sleep.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">asyncio</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">do_work</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
<span class="hll">        <span class="k">await</span> <span class="n">task</span>
</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 sleep.py

0:00:00.000177: Start work for number=0
0:00:00.000206: Start work for number=1
0:00:00.000214: Start work for number=2
0:00:00.000219: Start work for number=3
0:00:00.000224: Start work for number=4
0:00:02.001531: Finished work for number=0
0:00:02.001620: Finished work for number=1
0:00:02.001637: Finished work for number=2
0:00:02.001648: Finished work for number=3
0:00:02.001660: Finished work for number=4
Finished program after 0:00:02.002334
</code></pre></div>
</div>
</div>
</div>
<p>Similar to the <code>threading</code> and <code>multiprocessing</code> case, we could speed up the program by about a factor 5 here. The key differences here is the way we layout our program:</p>
<ol>
<li>Using the <strong>await</strong> keyword, we can tell the <em>event loop</em> to pause the execution of the function and work on another task. The event loop will then execute another task, until another <strong>await</strong> will be called, where the scheduler will give the control to yet another task. In the code above, each part where we tell the event loop that it can temporarily suspend the active task is highlighted. In the real world, these awaited calls often go to systems where we have to wait for a response like <em>Databases, IO or HTTP Calls</em>.</li>
<li>In line 19, we define the <strong>async event loop</strong>, that will be responsible for scheduling the resources between the tasks, and tell him to execute our <strong>async</strong> `main function.</li>
<li>Tasks can be scheduled using <code>asyncio.create_task</code>, which will then be executed in parallel. Calling <strong>await</strong> on the tasks will wait for the task to be executed (similar to <code>Thread.join</code>). If the async function has a return value, it can just be assigned via <code>value = await task</code>. </li>
<li>Only <strong>async functions</strong> can be awaited. Note, that you can just call regular synchronous code (like <em>print</em>) inside async functions, however it is <strong>not</strong> possible to call <em>async functions</em> from synchronous code!</li>
</ol>
<hr />
<p><strong>Asynchronous</strong> Python Code allow for true parallelism without the use of Threads or Processes, however there is still only one execution of Python Code at each time. Therefore, the <code>hard work</code> code:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Code</label><label for="__tabbed_6_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">hard_work.py</span><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">do_real_work</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Start work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="si">}</span><span class="s2">: Finished work for </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">do_real_work</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">task</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 hard_work.py

0:00:00.000176: Start work for number=0
0:00:02.103602: Finished work for number=0
0:00:02.103778: Start work for number=1
0:00:04.209974: Finished work for number=1
0:00:04.210021: Start work for number=2
0:00:06.322592: Finished work for number=2
0:00:06.322637: Start work for number=3
0:00:08.446054: Finished work for number=3
0:00:08.446091: Start work for number=4
0:00:10.562800: Finished work for number=4
Finished program after 0:00:10.563345
</code></pre></div>
</div>
</div>
</div>
<p>does not show a big improvement like in the <code>multiprocessing</code> example, leading to the final execution time overview:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>Synchronous Execution</strong></th>
<th><strong>Threading</strong></th>
<th><strong>Multiprocessing</strong></th>
<th><strong>Async/Await</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>sleep.py</strong></td>
<td style="text-align: center;">10</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td style="text-align: center;"><strong>do_work.py</strong></td>
<td style="text-align: center;">11.8</td>
<td>11.02</td>
<td>2.8</td>
<td>10.6</td>
</tr>
</tbody>
</table>
<h3 id="deeper-dive-into-asyncawait"><a class="toclink" href="../../2023/04/23/async-python/#deeper-dive-into-asyncawait">Deeper dive into Async/Await</a></h3>
<h4 id="parallel-http-requests"><a class="toclink" href="../../2023/04/23/async-python/#parallel-http-requests">Parallel HTTP Requests</a></h4>
<p>The real strength of asynchronous Code can be seen, if you are accessing <strong>external</strong> systems, where you have to wait for the response and the event loop can use the waiting time to do other things. Let us consider the following example of calling the <a href="https://pokeapi.co/">PokeAPI</a> to list us details about each Pokemon. We are using the awesome <a href="https://www.python-httpx.org/">httpx</a> libary, which is an async drop-in replacement for <code>requests</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Code</label><label for="__tabbed_7_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">unparallel_async.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">httpx</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">all_pokemon_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://pokeapi.co/api/v2/pokemon&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">})</span>
        <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">all_pokemon</span> <span class="o">=</span> <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">all_pokemon</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get information for `</span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
            <span class="n">pokemon_details_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
            <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">pokemon_details</span> <span class="o">=</span> <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ID: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Name: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Height: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Weight: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="err">`</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 unparallel_async.py

Get information for `bulbasaur`
ID: 1, Name: bulbasaur, Height: 7, Weight: 69
Get information for `ivysaur`
ID: 2, Name: ivysaur, Height: 10, Weight: 130
Get information for `venusaur`
ID: 3, Name: venusaur, Height: 20, Weight: 1000

...
Get information for `miraidon-glide-mode`
ID: 10271, Name: miraidon-glide-mode, Height: 28, Weight: 2400
Finished program after 0:03:15.133072
</code></pre></div>
</div>
</div>
</div>
<p>Downloading the details about ~1000 Pokemon took about 3 minutes for the program. This program seems to be asynchronous, but if you look closely, we are never calling an <code>asyncio.create_task</code> or <code>asyncio.gather</code> function that schedules async tasks in parallel. If you inspect the output you will see that the program just iterates through all Pokemon URLs and each times waits until each single request is finished.</p>
<p>With a little change, the program can be refactored to be fully asynchronous:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">Code</label><label for="__tabbed_8_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">parallel_async.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">httpx</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get information for `</span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
    <span class="n">pokemon_details_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
    <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">pokemon_details</span> <span class="o">=</span> <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;ID: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Name: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Height: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Weight: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">all_pokemon_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;https://pokeapi.co/api/v2/pokemon&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">all_pokemon</span> <span class="o">=</span> <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">)</span> <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">all_pokemon</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 parallel_async.py

Get information for `bulbasaur`
Get information for `ivysaur`
Get information for `venusaur`
Get information for `charmander`
Get information for `charmeleon`
...
Get information for `miraidon-aquatic-mode`
Get information for `miraidon-glide-mode`
ID: 1, Name: bulbasaur, Height: 7, Weight: 69
ID: 4, Name: charmander, Height: 6, Weight: 85
ID: 3, Name: venusaur, Height: 20, Weight: 1000
...
ID: 10187, Name: morpeko-hangry, Height: 3, Weight: 30
ID: 10226, Name: urshifu-single-strike-gmax, Height: 290, Weight: 10000
ID: 10131, Name: minior-yellow-meteor, Height: 3, Weight: 400
Finished program after 0:00:04.860879
</code></pre></div>
</div>
</div>
</div>
<p>This async version is about 50 times faster than the previous one! As can be seen, all ~1000 functions have first started and then requested and printed the result. The execution flow is shown below</p>
<figure>
<p><img alt="Async Execution Flow for Pokemon API Example" src="../../assets/images/async_pokemon.svg" width="1000" />
  </p>
<figcaption>Async Execution Flow for Pokemon API Example</figcaption>
</figure>
<h4 id="building-async-pipeline"><a class="toclink" href="../../2023/04/23/async-python/#building-async-pipeline">Building async pipeline</a></h4>
<p>So far, we used <code>asyncio.gather</code> or <code>asyncio.create_task</code> + <code>wait task</code> to create tasks in parallel. However, for this to work, we have to know which tasks we want to execute in advance. Let us now consider an example, where we have a <strong>slow service</strong>, that serves us with the URLs to request the Pokemon details:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">Code</label><label for="__tabbed_9_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">pokemon_pipeline.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span>

<span class="kn">import</span> <span class="nn">httpx</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_pokemons</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">all_pokemon_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://pokeapi.co/api/v2/pokemon&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get Url for Pokemon </span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># This is a slow producer, so we have to sleep:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">pokemon</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get information for `</span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
    <span class="n">pokemon_details_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
    <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">pokemon_details</span> <span class="o">=</span> <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;ID: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Name: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Height: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Weight: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">pokemons</span> <span class="o">=</span> <span class="n">get_pokemons</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">)</span> <span class="k">async</span> <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">pokemons</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 pokemon_pipeline.py

    Get Url for Pokemon bulbasaur
    Get Url for Pokemon ivysaur
    Get Url for Pokemon venusaur
    ...
    Get information for `bulbasaur`
    Get information for `ivysaur`
    Get information for `venusaur`
    ...
    ID: 10084, Name: pikachu-libre, Height: 4, Weight: 60
    ID: 879, Name: copperajah, Height: 30, Weight: 6500
    Finished program after 0:00:18.303518
</code></pre></div>
</div>
</div>
</div>
<p>As can be seen in the <em>output</em> , we first get all Pokemon URLs and after that we start our asynchronous HTTP Calls to get the Pokemon Details. This is <strong>not</strong> what we want. However, there is a way to already start the downloads of the details when we get our first URLs by using a Queue Mechanism:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Code</label><label for="__tabbed_10_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">pokemon_pipeline.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span>

<span class="kn">import</span> <span class="nn">httpx</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">pokemons_producer</span><span class="p">(</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="n">pokemons</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="n">all_pokemon_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://pokeapi.co/api/v2/pokemon&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">all_pokemon_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get Url for Pokemon </span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># This is a slow producer, so we have to sleep:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">pokemons</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pokemon</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">pokemons</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get information for `</span><span class="si">{</span><span class="n">pokemon</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
    <span class="n">pokemon_details_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
    <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">pokemon_details</span> <span class="o">=</span> <span class="n">pokemon_details_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;ID: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Name: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Height: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Weight: </span><span class="si">{</span><span class="n">pokemon_details</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">pokemon_details_consumer</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span> <span class="n">pokemons</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">):</span>
    <span class="n">consumer_active</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">consumer_active</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">pokemons_to_process</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">pokemons</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pokemon</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">pokemons</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pokemons_to_process</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pokemon</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consumer_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">print_pokemon_details</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">)</span> <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">pokemons_to_process</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">pokemons</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">pokemon_producer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">pokemons_producer</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pokemons</span><span class="p">))</span>
        <span class="n">pokemon_details_consumer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="n">pokemon_details_consumer</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pokemons</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pokemon_producer_task</span><span class="p">,</span> <span class="n">pokemon_details_consumer_task</span><span class="p">])</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished program after </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; python3 pokemon_pipeline.py

Get Url for Pokemon bulbasaur
Get Url for Pokemon ivysaur
Get Url for Pokemon venusaur
Get Url for Pokemon charmander
Get information for `bulbasaur`
Get information for `ivysaur`
Get information for `venusaur`
Get information for `charmander`
Get Url for Pokemon charmeleon
Get Url for Pokemon charizard
ID: 1, Name: bulbasaur, Height: 7, Weight: 69
Get Url for Pokemon squirtle
Get Url for Pokemon wartortle
Get Url for Pokemon blastoise
ID: 2, Name: ivysaur, Height: 10, Weight: 130
ID: 4, Name: charmander, Height: 6, Weight: 85
...
Finished program after 0:00:15.070663
</code></pre></div>
</div>
</div>
</div>
<p>Here, we have a producer (generates the Pokemon Details URLs) and a consumer task (exports details from URL). They communicate with each other via an <code>asyncio.Queue</code>, such that both can operate in parallel and we can start extracting the Pokemon Details as soon as the first URL has been published by the <strong>produced task</strong>. Using the same idea, it is then of course possible to generate a cascade of processes, where each intermediate task <em>consumes</em> from one task and <em>produces</em> objects that will then be processed by the next task.</p>

    <nav class="md-post__action">
      <a href="../../2023/04/23/async-python/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-08 00:00:00">March 8, 2023</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <p><img alt="" src="../../assets/images/multiprocessing_python.png" /></p>
<h2 id="caution-with-multiprocessing-and-ffspec-filesystems-in-python"><a class="toclink" href="../../2023/03/08/multiprocessing_and_fsspec/">Caution with Multiprocessing and ffspec Filesystems in Python</a></h2>
<p>Multiprocessing can be a great way of scaling Python applications beyond one CPU core, especially due slow speed compared to other lower-level languages like C or Java. However, one has to be very careful when passing Python class instance, especially if your are using a <a href="https://filesystem-spec.readthedocs.io/en/latest/">fsspec</a> filesystem implementation. </p>
<p><strong>Note</strong>: At time of writing of this article the newest <code>fsspec</code> release was <a href="https://github.com/fsspec/filesystem_spec/tree/2023.3.0">2023.3.0</a>.</p>
<h3 id="the-problem"><a class="toclink" href="../../2023/03/08/multiprocessing_and_fsspec/#the-problem">The Problem</a></h3>
<p><strong>Filesystem Spec</strong> (<a href="https://filesystem-spec.readthedocs.io/en/latest/">fsspec</a>) is a Python package that provides a unified interface for filesystems. However, one has to be very carefull, when running tasks on an fsspec Filesystem in parallel. Let us consider the following code:
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">fsspec</span> <span class="kn">import</span> <span class="n">AbstractFileSystem</span>

<span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">MyFS</span><span class="p">(</span><span class="n">AbstractFileSystem</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">return_store</span><span class="p">(</span><span class="n">my_class</span><span class="p">:</span> <span class="n">MyClass</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Class Name: </span><span class="si">{</span><span class="n">my_class</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">:</span><span class="s2"> &lt;10</span><span class="si">}</span><span class="s2"> Store: </span><span class="si">{</span><span class="n">my_class</span><span class="o">.</span><span class="n">store</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1">## Create class instance in parent process and add stuff to the internal store:</span>
<span class="n">my_class</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="n">my_class</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="s2">&quot;added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;content&quot;</span>

<span class="n">my_fs</span> <span class="o">=</span> <span class="n">MyFS</span><span class="p">()</span>
<span class="n">my_fs</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="s2">&quot;added&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;content&quot;</span>


<span class="c1">## Run the function in a child process:</span>
<span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">return_store</span><span class="p">,</span>
        <span class="p">[</span><span class="n">my_class</span><span class="p">,</span> <span class="n">my_fs</span><span class="p">],</span>
    <span class="p">)</span>


<span class="c1">## Print out store content from child processes:</span>
<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></p>
<p>What we have here are two very simple classes <code>MyClass</code> and <code>MyFS</code> that just create an empty <em>dictionary</em> <code>store</code> attribute when instantiated. The key difference between these two classes is that <code>MyFS</code> is inherited from <code>fsspec.AbstractFileSystem</code>. We then create an instance of each of the two classes and add an entry to the <code>store</code> <em>dictionary</em>. Finally, we run a simple function in 2 child processes that just prints out the content of the <code>store</code> attribute. The resulting output of this script will be:</p>
<pre><code>Class Name: MyClass    Store: {'added': 'content'}
Class Name: MyFS       Store: {}
</code></pre>
<p>As can be seen, the <code>store</code> attribute of the <code>MyFS</code> class does <strong>not contain the added entry</strong>, whereas the same class without inheritance from the <code>AbstractFileSystem</code> does contain the non-empty dictionary. The reason behind these two different behaviours lies in the <strong>caching</strong> implementation of <code>fsspec</code>. The inheritance diagram looks like:
<pre class="mermaid"><code>---
title: Class Diagram MyFS
---
classDiagram
    `fsspec.spec._Cached` &lt;|-- `fsspec.AbstractFileSystem`
    `fsspec.AbstractFileSystem` &lt;|-- `MyFS`

    class `fsspec.spec._Cached`{
        __init__()
        __call__()
    }
    class `fsspec.AbstractFileSystem`{
        + ...
    }</code></pre></p>
<p><a href="https://github.com/fsspec/filesystem_spec/blob/2023.3.0/fsspec/spec.py#L70">This line</a> in the <code>_Cached</code> base is responsible for removing all existing attributes on the class instance when it will be forked for the child process:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">_Cached</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>
<span class="hll">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_pid</span><span class="p">:</span>
</span><span class="hll">            <span class="c1"># In a child process, this line is called and will clear all existing attributes:</span>
</span><span class="hll">            <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>        
</span>        <span class="o">...</span>
</code></pre></div></p>
<h3 id="possible-solutions"><a class="toclink" href="../../2023/03/08/multiprocessing_and_fsspec/#possible-solutions">Possible solutions</a></h3>
<p>If you really want to parallelize applications with an <code>fsspec</code> Filesystem, there are at least 2 solutions.</p>
<h4 id="use-threading"><a class="toclink" href="../../2023/03/08/multiprocessing_and_fsspec/#use-threading">Use threading</a></h4>
<p>If you run the code above with a <code>multiprocessing.pool.ThreadPool</code> instead of a <code>multiprocessing.Pool</code>, it just runs fine and does not show the observed caching behaviour.                                                              </p>
<h4 id="instantiate-the-filesystem-inside-the-processes-itself"><a class="toclink" href="../../2023/03/08/multiprocessing_and_fsspec/#instantiate-the-filesystem-inside-the-processes-itself">Instantiate the filesystem inside the processes itself</a></h4>
<p>Instead of passing the instatiated filesystem directly into the subprocess, it is better to use an <strong>Adapter</strong> that stores the information about the filesystem and can create an instance of it. Let us consider the following example:
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">fsspec.implementations.github</span> <span class="kn">import</span> <span class="n">GithubFileSystem</span>

<span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s2">&quot;fork&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GithubFileSystemAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org</span> <span class="o">=</span> <span class="n">org</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">get_github_fs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GithubFileSystem</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GithubFileSystem</span><span class="p">(</span><span class="n">org</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">list_root_directory_of_repository</span><span class="p">(</span>
    <span class="n">github_fs_adapter</span><span class="p">:</span> <span class="n">GithubFileSystemAdapter</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># Create fsspec filesystem inside child process:</span>
    <span class="n">github_fs</span> <span class="o">=</span> <span class="n">github_fs_adapter</span><span class="o">.</span><span class="n">get_github_fs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">github_fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>


<span class="c1">## Create GithubFileSystemAdapter for &#39;https://github.com/python/cpython&#39;:</span>
<span class="n">github_fs_adapter</span> <span class="o">=</span> <span class="n">GithubFileSystemAdapter</span><span class="p">(</span><span class="n">org</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="s2">&quot;cpython&quot;</span><span class="p">)</span>


<span class="c1">## Run the function in a child process:</span>
<span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">list_root_directory_of_repository</span><span class="p">,</span>
        <span class="p">[</span><span class="n">github_fs_adapter</span><span class="p">],</span>
    <span class="p">)</span>

<span class="c1">## Print out store content from child process:</span>
<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></p>
<p>As can be seen, we define a container class <code>GithubFileSystemAdapter</code> that simply stores the data and implements a method for creating the filesystem. This container class is then passed to the child process, within which the <code>fsspec</code> filessystem object is created. It can then be safely used without the problems seen in the previous example.</p>

    <nav class="md-post__action">
      <a href="../../2023/03/08/multiprocessing_and_fsspec/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["search.highlight", "search.suggest", "search.share", "toc.follow", "toc.integrate", "navigation.instant", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4e31edb1.min.js"></script>
      
    
  </body>
</html>